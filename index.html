<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS 系統需求規格 v2.5：完整版邏輯修正與規格補完</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        /* Thermal Receipt Styling */
        .receipt-paper {
            background-color: #ffffff;
            font-family: 'Courier New', Courier, monospace;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e5e5;
            position: relative;
            transition: all 0.3s ease;
            width: 320px;
        }

        .receipt-paper::before {
            content: "";
            position: absolute;
            top: -5px;
            left: 0;
            width: 100%;
            height: 5px;
            background: radial-gradient(circle, transparent, transparent 50%, #ffffff 50%, #ffffff 100%) -7px -8px / 16px 16px repeat-x;
            transform: rotate(180deg);
        }

        .receipt-paper::after {
            content: "";
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 5px;
            background: radial-gradient(circle, transparent, transparent 50%, #ffffff 50%, #ffffff 100%) -7px -8px / 16px 16px repeat-x;
        }

        .printer-slot {
            height: 12px;
            background: #111827;
            border-radius: 6px;
            width: 280px;
            margin: 0 auto 0 auto;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.8);
            position: relative;
            z-index: 20;
        }

        .toggle-btn.active {
            background-color: #ea580c; /* Orange-600 */
            color: white;
            border-color: #ea580c;
        }

        .section-highlight {
            border-left: 4px solid #ea580c;
        }
        
        /* Radio Button Styling */
        .scenario-radio:checked + div {
            border-color: #ea580c;
            background-color: #fff7ed;
            color: #c2410c;
        }
        .scenario-radio:checked + div .radio-dot {
            background-color: #ea580c;
            border-color: #ea580c;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 180px;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Navigation -->
    <nav class="bg-white shadow border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <span class="text-2xl font-bold text-gray-800 tracking-tight">POS 規格書</span>
                    <span class="bg-orange-100 text-orange-800 text-xs font-bold px-2 py-0.5 rounded">v2.5 完整修正版</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-10">

        <!-- 1. Executive Summary -->
        <section id="dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-3 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h1 class="text-2xl font-bold text-gray-900 mb-2">發票作廢與贈品回收優化案</h1>
                <p class="text-gray-600">
                    針對「跨期折讓」與「多筆累計贈品」之帳務防呆機制。解決退貨時，原發票贈品資訊不明，導致樓管無法準確回收贈品或計算現金買回金額之問題。
                </p>
            </div>

            <!-- Priority Card -->
            <div class="bg-orange-50 p-5 rounded-lg border border-orange-200 section-highlight">
                <h3 class="text-sm font-bold text-orange-800 uppercase mb-2">核心需求 (Priority 1)</h3>
                <ul class="space-y-2 text-sm text-gray-700">
                    <li class="flex items-start">
                        <span class="mr-2 text-orange-600 font-bold">1.</span>
                        <span>作廢/退貨皆需列印明細 (含跨期折讓)。</span>
                    </li>
                    <li class="flex items-start">
                        <span class="mr-2 text-orange-600 font-bold">2.</span>
                        <span>贈品回收需依據「剩餘金額」動態判斷門檻。</span>
                    </li>
                </ul>
            </div>

            <!-- Point/Amount Logic Card -->
            <div class="bg-blue-50 p-5 rounded-lg border border-blue-200 section-highlight" style="border-color: #3b82f6;">
                <h3 class="text-sm font-bold text-blue-800 uppercase mb-2">v2.5 邏輯變更 (重點)</h3>
                <ul class="space-y-2 text-sm text-gray-700">
                    <li class="flex items-start">
                        <span class="mr-2 text-blue-600 font-bold">●</span>
                        <span>點數回收：該張發票基礎點數全扣 (-50)，無比例問題。</span>
                    </li>
                    <li class="flex items-start">
                        <span class="mr-2 text-blue-600 font-bold">●</span>
                        <span>金額格式：移除「(部分)」字樣，僅顯示純負數值。</span>
                    </li>
                </ul>
            </div>

            <!-- Fallback Plan -->
            <div class="bg-gray-50 p-5 rounded-lg border border-gray-200 section-highlight" style="border-color: #6b7280;">
                <h3 class="text-sm font-bold text-gray-700 uppercase mb-2">備案機制 (Priority 2)</h3>
                <p class="text-sm text-gray-600 mb-2 font-bold">若補印功能開發不及：</p>
                <div class="bg-white p-2 rounded border border-gray-300 text-xs text-gray-600 leading-relaxed">
                    於退貨交易當下，強制自動列印 2 張退貨明細 (商場聯/顧客聯)。
                </div>
            </div>
        </section>

        <!-- 2. Simulator Section -->
        <section id="simulator" class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
            <div class="bg-gray-900 text-white p-4 flex flex-wrap items-center justify-between">
                <div>
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                        POS 憑證輸出模擬器 (v2.5)
                    </h2>
                </div>
                
                <div class="flex gap-4 mt-2 md:mt-0 items-center">
                    <div class="bg-gray-800 p-2 rounded-lg flex gap-1">
                        <span class="text-[10px] text-gray-400 font-bold uppercase mr-2 self-center">交易類型</span>
                        <div class="flex rounded shadow-sm">
                            <button onclick="setTransType('current')" id="btn-current" class="toggle-btn active px-3 py-1 text-xs font-bold rounded-l border border-gray-600">當期作廢</button>
                            <button onclick="setTransType('cross')" id="btn-cross" class="toggle-btn px-3 py-1 text-xs font-bold rounded-r border border-gray-600 bg-gray-700 text-gray-300">跨期折讓</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 min-h-[600px]">
                <div class="lg:col-span-4 bg-gray-50 p-6 border-r border-gray-200">
                    <h3 class="font-bold text-gray-800 mb-4">贈品情境選擇</h3>
                    <div class="space-y-3">
                        <label class="cursor-pointer block relative">
                            <input type="radio" name="giftScenario" value="standard" class="scenario-radio sr-only" onchange="updateReceipt()" checked>
                            <div class="p-4 rounded-lg border-2 border-gray-200 bg-white">
                                <div class="flex items-center text-sm font-bold">
                                    <div class="radio-dot w-4 h-4 rounded-full border border-gray-300 mr-3"></div>
                                    全額退貨 (標準)
                                </div>
                            </div>
                        </label>
                        <label class="cursor-pointer block relative">
                            <input type="radio" name="giftScenario" value="threshold_failed" class="scenario-radio sr-only" onchange="updateReceipt()">
                            <div class="p-4 rounded-lg border-2 border-gray-200 bg-white">
                                <div class="flex items-center text-sm font-bold">
                                    <div class="radio-dot w-4 h-4 rounded-full border border-gray-300 mr-3"></div>
                                    部分退貨 (未達滿額門檻)
                                </div>
                                <p class="text-xs text-red-600 mt-1 ml-7">需收回抵用券</p>
                            </div>
                        </label>
                        <label class="cursor-pointer block relative">
                            <input type="radio" name="giftScenario" value="threshold_met" class="scenario-radio sr-only" onchange="updateReceipt()">
                            <div class="p-4 rounded-lg border-2 border-gray-200 bg-white">
                                <div class="flex items-center text-sm font-bold">
                                    <div class="radio-dot w-4 h-4 rounded-full border border-gray-300 mr-3"></div>
                                    部分退貨 (仍達滿額門檻)
                                </div>
                                <p class="text-xs text-green-600 mt-1 ml-7">無需收回抵用券</p>
                            </div>
                        </label>
                    </div>

                    <div id="scenario-hint" class="mt-6 p-4 bg-gray-100 rounded text-xs text-gray-600 border border-gray-200 leading-relaxed">
                        <!-- JS Dynamic Content -->
                    </div>
                </div>

                <div class="lg:col-span-8 bg-gray-100 p-8 flex flex-col items-center justify-start relative overflow-y-auto">
                    <div class="printer-slot"></div>
                    <div class="flex flex-wrap justify-center gap-6 relative top-[-10px]">
                        
                        <!-- Allowance Slip -->
                        <div id="receipt-allowance" class="hidden flex-col items-center">
                            <div class="receipt-paper h-[220px] p-4 text-[10px] text-gray-300 flex flex-col items-center justify-center border-t-0">
                                <span class="font-bold text-lg rotate-[-5deg] border-2 border-gray-300 p-1 mb-2">折讓證明單</span>
                                <p>財政部標準格式</p>
                            </div>
                            <span class="text-xs font-bold text-gray-500 mt-2">折讓單 x2</span>
                        </div>

                        <!-- Return Detail -->
                        <div class="flex flex-col items-center">
                            <div class="receipt-paper p-6 text-xs text-gray-800 leading-tight shadow-xl">
                                <div class="text-center mb-4">
                                    <h3 class="text-sm font-bold">TAIPEI101購物中心</h3>
                                    <h4 class="text-base font-bold my-1">退貨明細表</h4>
                                    <p>2026-02-02 14:30:00</p>
                                    <span class="inline-block bg-black text-white text-[10px] px-1 mt-1 font-sans">商場留存聯</span>
                                </div>
                                <hr class="border-dashed border-gray-400 my-2">
                                <div class="mb-4">
                                    <div class="flex justify-between font-bold">
                                        <span>商品名稱</span>
                                        <span>金額</span>
                                    </div>
                                    <div class="flex justify-between mt-1">
                                        <span>(退) A專櫃-化妝品</span>
                                        <span id="trans-amt" class="font-mono">-5,000</span>
                                    </div>
                                    <p class="text-[10px] text-gray-500">原發票: AB-12345678</p>
                                </div>
                                <hr class="border-dashed border-gray-400 my-2">
                                <div class="mb-3 opacity-60">
                                    <h5 class="font-bold border-l-2 border-gray-400 pl-1 mb-1 text-[11px]">【原交易獲贈資訊】</h5>
                                    <div class="pl-2 space-y-0.5 text-[10px]">
                                        <div class="flex justify-between"><span>會員點數:</span><span>50 點</span></div>
                                        <div class="flex justify-between"><span>滿額抵用券:</span><span>$500 (1張)</span></div>
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-2 -mx-2 mb-2 border-y border-gray-200">
                                    <h5 class="font-bold border-l-4 border-orange-500 pl-1 mb-2 text-[11px]">【本次應收回明細】</h5>
                                    <div class="flex justify-between items-center mb-1">
                                        <span>會員點數:</span>
                                        <span id="rec-points-val" class="font-bold font-mono">-50</span>
                                    </div>
                                    <div class="text-[10px] text-green-700 mb-2 pl-2">✓ 系統自動扣除</div>
                                    <div class="flex justify-between items-center mb-1">
                                        <span>電子抵用券:</span>
                                        <span id="rec-voucher-val" class="font-bold font-mono">$500 (-1張)</span>
                                    </div>
                                    <div id="rec-voucher-status" class="text-[10px] pl-2 mb-2 text-gray-500">券號: ...9901 (Void)</div>
                                    <div class="bg-white border border-gray-300 p-1.5 rounded mt-1">
                                        <p class="font-bold text-[10px] text-red-600">⚠️ 服務台人工收回確認:</p>
                                        <div class="flex items-center gap-2 mt-1">
                                            <div class="w-3 h-3 border border-gray-400 rounded-sm"></div>
                                            <span class="text-[10px]">馬克杯 / 實體券</span>
                                        </div>
                                    </div>
                                </div>
                                <hr class="border-dashed border-gray-400 my-2">
                                <div class="flex justify-between font-bold text-sm">
                                    <span>退款總額</span>
                                    <span id="total-refund" class="font-mono">$-5,000</span>
                                </div>
                                <div class="mt-8 pt-2 border-t border-black text-center text-[10px]">
                                    <div class="flex justify-between mb-8">
                                        <span>樓管簽章:_________</span>
                                        <span>顧客簽名:_________</span>
                                    </div>
                                </div>
                            </div>
                            <span class="text-xs font-bold text-gray-500 mt-2">退貨明細 x2 (商/客)</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. Logic & Charts -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <span class="bg-orange-600 w-1.5 h-6 rounded-full"></span>
                    贈品門檻動態重算邏輯
                </h3>
                <p class="text-sm text-gray-600 mb-4">系統需判斷該筆退貨後的「剩餘有效交易金額」是否仍符合活動門檻，以決定是否回收券類。</p>
                <div class="space-y-3">
                    <div class="p-3 bg-red-50 rounded-lg border border-red-100 flex items-center gap-3">
                        <div class="bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded">未達門檻</div>
                        <p class="text-xs text-gray-700">原獲贈券類需 <span class="font-bold text-red-600">全數追回</span>，點數全扣。</p>
                    </div>
                    <div class="p-3 bg-green-50 rounded-lg border border-green-100 flex items-center gap-3">
                        <div class="bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded">仍達門檻</div>
                        <p class="text-xs text-gray-700">原獲贈券類 <span class="font-bold text-green-600">保留 ($0)</span>，點數仍全扣 (v2.5)。</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h3 class="font-bold text-lg mb-4">預期效益</h3>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <p class="text-xs text-gray-500 text-center mb-2 font-bold">現場核對時間 (分鐘)</p>
                        <div class="chart-container"><canvas id="chartTime"></canvas></div>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 text-center mb-2 font-bold">贈品糾紛案件 (件/月)</p>
                        <div class="chart-container"><canvas id="chartDispute"></canvas></div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
        const state = { transType: 'current', giftScenario: 'standard' };

        function setTransType(type) {
            state.transType = type;
            document.getElementById('btn-current').className = type === 'current' 
                ? 'toggle-btn active px-3 py-1 text-xs font-bold rounded-l border border-gray-600'
                : 'toggle-btn px-3 py-1 text-xs font-bold rounded-l border border-gray-600 bg-gray-700 text-gray-300';
            document.getElementById('btn-cross').className = type === 'cross' 
                ? 'toggle-btn active px-3 py-1 text-xs font-bold rounded-r border border-gray-600'
                : 'toggle-btn px-3 py-1 text-xs font-bold rounded-r border border-gray-600 bg-gray-700 text-gray-300';
            
            const allowance = document.getElementById('receipt-allowance');
            if(type === 'cross') {
                allowance.classList.remove('hidden');
                allowance.classList.add('flex');
            } else {
                allowance.classList.add('hidden');
                allowance.classList.remove('flex');
            }
            updateReceipt();
        }

        function updateReceipt() {
            const radios = document.getElementsByName('giftScenario');
            for (const radio of radios) { if (radio.checked) { state.giftScenario = radio.value; break; } }

            const scenarioHint = document.getElementById('scenario-hint');
            const transAmt = document.getElementById('trans-amt');
            const totalRefund = document.getElementById('total-refund');
            const ptsVal = document.getElementById('rec-points-val');
            const voucherVal = document.getElementById('rec-voucher-val');
            const voucherStatus = document.getElementById('rec-voucher-status');

            ptsVal.innerText = "-50"; // v2.5 Requirement: Always -50

            if (state.giftScenario === 'standard') {
                scenarioHint.innerHTML = '<span class="font-bold block mb-1">💡 全額退貨：</span>整筆交易作廢，點數與券類同步回收。';
                transAmt.innerText = "-5,000";
                totalRefund.innerText = "$-5,000";
                voucherVal.innerText = "$500 (-1張)";
                voucherStatus.innerText = "券號: ...9901 (Void)";
                voucherStatus.className = "text-[10px] pl-2 mb-2 text-gray-500";
            } else if (state.giftScenario === 'threshold_failed') {
                scenarioHint.innerHTML = '<span class="font-bold block mb-1 text-red-700">💡 部分退貨 (未達標)：</span>剩餘累積金額不足門檻，<span class="font-bold underline">抵用券需回收</span>。點數固定回收 -50。';
                transAmt.innerText = "-2,000";
                totalRefund.innerText = "$-2,000";
                voucherVal.innerText = "$500 (-1張)";
                voucherStatus.innerText = "未達門檻 (追回)";
                voucherStatus.className = "text-[10px] pl-2 mb-2 text-red-600 font-bold";
            } else if (state.giftScenario === 'threshold_met') {
                scenarioHint.innerHTML = '<span class="font-bold block mb-1 text-green-700">💡 部分退貨 (仍達標)：</span>剩餘金額仍符資格，<span class="font-bold underline">抵用券由顧客保留</span>。點數仍固定回收 -50。';
                transAmt.innerText = "-2,000";
                totalRefund.innerText = "$-2,000";
                voucherVal.innerText = "$0 (保留)";
                voucherStatus.innerText = "符合資格 (免回收)";
                voucherStatus.className = "text-[10px] pl-2 mb-2 text-green-600 font-bold";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const chartOpt = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false } } };
            new Chart(document.getElementById('chartTime'), { type: 'bar', data: { labels: ['Before', 'After'], datasets: [{ data: [15, 3], backgroundColor: ['#d1d5db', '#ea580c'], borderRadius: 4 }] }, options: chartOpt });
            new Chart(document.getElementById('chartDispute'), { type: 'bar', data: { labels: ['Before', 'After'], datasets: [{ data: [12, 1], backgroundColor: ['#d1d5db', '#3b82f6'], borderRadius: 4 }] }, options: chartOpt });
            updateReceipt();
        });
    </script>
</body>
</html>